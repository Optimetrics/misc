CoinWatch - A simple daemon to monitor for Bitcoin payments and update mysql tables.

This code is adapted from code I wrote to support an online Bitcoin service. 

It maintains user account balances and watches for any payments made to update the accounts. It also updates a "jobs" table that controls something that an account balance allows to proceed or not. 

This code may not work as is. I edited some values to make it more general for others and remove db specifics. I didn't have a chance to test it again before uploading. Therefore, use this as a start point to adapt from and test well before any actual commercial use.

Brief overview of code:

The main run loop polls for block count change. When a new block is detected we look at a previous block (according to confirmation count) and call CheckBlock to retrieve the block and scan for any addresses that match our users. Check4Pmts will look at each transaction and see if it has an output for an account address that has not already been recorded. It updates the pmts table (history) and user balance. UpdateJobStatus looks at the resulting balance and decides what action should happen. In this example it checks job costs and changes status to either allow jobs to proceed or remain on hold. This function would be modified to suit a particular application.

Several mysql tables are used here:

users - info about each user account including their address and balance.
pmts - payment audit history with various details for each payment detected.
jobs - info about pending jobs that may be run when a user has sufficient balance.

In my application another backend process detects job status and actually runs jobs.

Config values determine some parameters for how the watch runs.

minconfirm - the confirmation count for low value pmts.
maxconfirm - the confirmation count for high value pmts.
confirmbreak - a bitcoin value above which max confirmations are required.
poll - how many seconds to poll for new blocks (how quickly a pmt is detected).
block - the block number to start watching from. If this is in the past then it will work thru old blocks bringing itself up to date.
user - a userid to run as when started during system boot by root user. (Not recently tested so may have some problem)

The config file is updated with block count so that if the daemon restarts it can continue where it left off.

That's all folks. Hope this is useful. 
